<!DOCTYPE html>
<html>

<head>
    <title>Deposit Funds</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .StripeElement {
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 4px;
        }

        .StripeElement--focus {
            border-color: #4CAF50;
        }

        .StripeElement--invalid {
            border-color: #f44336;
        }
    </style>
</head>

<body>
    <form id="deposit-form">
        <h2>Deposit Funds</h2>

        <label>
            Amount (USD):
            <input type="number" id="amount" step="0.01" min="1" required>
        </label>

        <label>
            Card Details:
            <div id="card-element"></div>
        </label>

        <div id="card-errors" role="alert"></div>

        <button type="submit" id="submit-button">
            Deposit $<span id="amount-display">0.00</span>
        </button>
    </form>

    <script>
        // Initialize Stripe
        const stripe = Stripe('pk_test_51KndLMJMbcYUPEPUmIyiSrN4KE50Za4XplFUAbFVhysGnWy4XVfdsUs9JCunGQHMmWuSPKZ5B02gi74G43zR7Q0I008TVRQGpG');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        // Handle real-time validation errors
        cardElement.on('change', (event) => {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        // Update amount display
        document.getElementById('amount').addEventListener('input', (e) => {
            document.getElementById('amount-display').textContent = e.target.value;
        });

        // Handle form submission
        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            try {
                const amount = parseFloat(document.getElementById('amount').value);

                // 1. Create deposit
                const depositResponse = await fetch('/api/v1/deposits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer 5|sO2aMkuoSrQCiCSQQNT0V4EomBq9aKNqAc3vT1Ad811ed5d5',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        currency_code: 'USD',
                        amount: amount,
                        payment_method: 'card'
                    })
                });

                const depositData = await depositResponse.json();

                if (!depositData.success) {
                    throw new Error(depositData.message);
                }

                const clientSecret = depositData.data.client_secret;

                // 2. Confirm payment
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement,
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                if (paymentIntent.status === 'succeeded') {
                    alert('Payment successful! Your wallet will be credited shortly.');
                    // window.location.href = '/deposits';
                }

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Deposit';
            }
        });
    </script>
</body>

</html>
